<html>
  <head>
    <script src="script/createjs-2013.05.14.min.js"></script>
    <script src="files/Button.js"></script>
    <script src="files/p2.js"></script>
    <script src="files/UI.js"></script>
    <script src="files/Handle.js"></script>
    <script src="script/jquery.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io.connect('http://140.136.150.87');

      var playerid = prompt('What is your id?');
      var slave_color, slave_image, arr;

      var wtf = 1, wtf_click=0, wtf_slave = 1, ttt, cou=1;      

      var canvas, stage, cont, cont_2, cont_3, cont_UI, cont_temp_slave, degree, ttt;//"ttt"為該回合所抽取的卡片種類
      var mouseTarget;	// the display object currently under the mouse, or being dragged
      var dragStarted;	// indicates whether we are currently in a drag operation
      var offset;
      var cardX = new Array(72); //紀錄卡片位置
      var cardY = new Array(72);
      var TypeOfCard = new Array(72); // 紀錄卡片種類
      var CardsDegree = new Array(72); //紀錄卡片旋轉度數
      
      //var RedRange = new Array(72);  //可擺放之卡片按鈕
      var temp; //別看我,我只是函數間傳值的變數
      var HowManyCard; //已出現的卡片數量
      var RedNumber;  //紀錄卡片可擺放處之數量（隨著每次新增卡片而變動）
      var HowManyPlayer=0;//玩家人數
      var RedRangeX = new Array(72);  //紀錄卡片可擺位置
      var RedRangeY = new Array(72);
      //var rotate_degree=0;	//旋轉角度
      var update = true;
      
      window.onload=function(){
        // create stage and point it to the canvas:
        canvas = document.getElementById("testCanvas");
        
        //check to see if we are running in a browser with touch support
        stage = new createjs.Stage(canvas);
        
        cont = new createjs.Container();
        cont_2 = new createjs.Container();
        cont_3 = new createjs.Container();
        cont_UI = new createjs.Container();
       cont_temp_slave = new createjs.Container(); //放slave的產生位置(每回合都會變) , 所以每次確定後會刪除此此containerr內的物件
        cont_slave = new createjs.Container(); //放每個人確定後的slave物件
        
        stage.addChild(cont_3);
        stage.addChild(cont_2);
        stage.addChild(cont_temp_slave);
        stage.addChild(cont_slave);
        stage.addChild(cont_UI);
        stage.addChild(cont);
        
        cont_2.onPress = function(evt) {
				  var offset = {x:evt.target.x-evt.stageX, y:evt.target.y-evt.stageY};
				
				  evt.onMouseMove = function(ev) {
					  ev.target.x = ev.stageX+offset.x;
					  ev.target.y = ev.stageY+offset.y;
					
					  cont_3.x = ev.target.x; cont_3.y = ev.target.y;
					  cont_temp_slave.x = ev.target.x; cont_temp_slave.y = ev.target.y;
				  }
				
			  }
		
		    //Staring image
		    var image = new Image();
          image.src = "assets/20c.png"
          image.onload = handleImageLoad;
          
          LoadUI();
          
          // enable touch interactions if supported on the current device:
          createjs.Touch.enable(stage);
          
          // enabled mouse over / out events
          stage.enableMouseOver(50);
          stage.mouseMoveOutside = true; // keep tracking the mouse even when it leaves the canvas
          
          
          
        }
        
      function add() {
      	
      	
      	//cont_3.x = cont_2.x = 100;
      	//cont_3.y = cont_2.y = 150;
      
        var image = new Image();
        ttt=Math.ceil(24* Math.random());
        image.src = "assets/" + ttt+ "c.png"
        image.onload = handleImageLoad;
        degree=90;
        
        RedNumber=-1;
        
        judge();
        update = true;
      }      
      
      function out() {
      	wtf--;
      	wtf_click=0;      	
      	cont.removeChildAt(0);
      	cont_2.removeChildAt(HowManyCard);
      	cont_3.removeAllChildren();
      	if(wtf==2){
      	  cont_2.removeChildAt(0);
      		HowManyCard=0;
      		wtf=1;
      		var image = new Image();
          image.src = "assets/11c.png"
          image.onload = handleImageLoad;
        
        }
      	update=true;
      	stage.update();
      
      }
      
      $(document).ready(function() {
        socket.emit('id', playerid);
        socket.on('turn', function (data) {
          console.log(data);
          var add = $("#add");
          if(data === slave_color) {
            console.log("ur turn");
            add.show();
          }
          else {
            var check = cont_UI.getChildByName("check");
            check.visible = false;
            update = true;
            add.hide();
          }
          var colors = ['blue', 'gray', 'green', 'red', 'yellow'];
          for(var i in colors) {
            var handcard = cont_UI.getChildByName("handcard-" + colors[i]);
            console.log("slave-" + colors[i]);
            if(data != colors[i]) {
              handcard.alpha = 0.5;
            }
            else {
              handcard.alpha = 1;
            }
            update = true;
          }
        });
        socket.on('alert', function(str) {
          alert(str);
        });
      });
      socket.on('color', function(color) {
        slave_color = color;
        slave_image.src = "assets/slave-" + color + ".png";
        console.log(color);
        cont_UI.addChild(cont_UI.getChildByName("slave"));
      });
      socket.on('show', function(arr) {
        console.log(arr);
        
        if(slave_color != arr[4]) {
		    var image = new Image();
		    ttt = arr[0];
		    xxx = (arr[3]-69)*150;
		    yyy = (arr[2]-70)*150;
		    image.src = "assets/" + ttt + "c.png"
		    image.onload = function(event) {
		      var image = event.target;
		      var bitmap;
		      bitmap = new createjs.Bitmap(image);
		      cont_2.addChild(bitmap);
		      bitmap.regX = bitmap.image.width/2|0;
		      bitmap.regY = bitmap.image.height/2|0;
		      bitmap.scaleX = bitmap.scaleY = bitmap.scale = 0.5;
		      bitmap.name = "bmp_"+wtf;
		      bitmap.x = (arr[3]-69)*150;
		      bitmap.y = (arr[2]-70)*150;
		      wtf++;
		      degree=arr[1] ;
		      bitmap.rotation=degree;
		    RedNumber = -1;
		    HowManyCard ++;
		    /*var bitmap = cont_2.getChildByName("bmp_"+(wtf));
		    bitmap.y = yyy;
		    bitmap.x = xxx;*/
		    cardX[HowManyCard-1] = xxx; 
		    cardY[HowManyCard-1] = yyy;
		    RedNumber=0;wtf_click=0;
		    cou++;
		    CardsDegree[HowManyCard-1] = degree;
		    direction =  (degree)/90;
		    console.log(degree-90 + "  DDDD");
		    TypeOfCard[HowManyCard-1] = ttt;
		    n=ttt;
		    direction %= 4 ; // 旋轉次數 mod 4
			n += (24*direction);
		    mapInfo[(yyy/150)-2+72][(xxx/150)-3+72]=n;
		    //console.log(n);
		    
        }
        	
        }
        else {
        	
        }
        
        update = true;
      });
    </script>
  </head>

  <body>
    <div style="width:900px;margin-left:auto;margin-right:auto;">
    <canvas id="testCanvas" width="950" height="650" style="background:#203038"></canvas>
    <button id="add" onclick="add()">Add New</button>
    <button onclick="out()">Out</button>
    </div>
  </body>
</html>
